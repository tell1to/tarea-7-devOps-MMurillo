name: CI/CD Pipeline - Build and Package

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job de pruebas
  test:
    name: Ejecutar Pruebas Unitarias
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout del c贸digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
      
    - name: Ejecutar pruebas unitarias
      run: npm test
      
    - name: Generar reporte de cobertura
      run: npm test -- --coverage
      
    - name: Subir reporte de cobertura
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30

  # Job de construcci贸n y empaquetado
  build:
    name: Construir y Empaquetar
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: Checkout del c贸digo
      uses: actions/checkout@v4
      
    - name: Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Instalar dependencias
      run: npm ci
      
    - name: Verificar calidad de c贸digo
      run: |
        echo "Verificando sintaxis..."
        node -c src/math.js
        node -c src/app.js
        
    - name: Construir la aplicaci贸n
      run: npm run build
      
    - name: Crear package
      run: npm run package
      
    - name: Verificar package generado
      run: |
        echo " Verificando package..."
        PACKAGE_FILE=$(ls *.tgz)
        echo "Package encontrado: $PACKAGE_FILE"
        
        # Verificar que el archivo existe
        if [ -f "$PACKAGE_FILE" ]; then
          echo "Package creado exitosamente"
          
          # Mostrar informaci贸n del package
          echo " Informaci贸n del package:"
          tar -tzf "$PACKAGE_FILE" | head -10
          
          # Verificar tama帽o
          echo " Tama帽o del package:"
          ls -lh "$PACKAGE_FILE"
        else
          echo " Error: No se encontr贸 el package"
          exit 1
        fi
        
    - name: Validar contenido del package
      run: |
        PACKAGE_FILE=$(ls *.tgz)
        echo "Validando contenido del package..."
        
        # Extraer y verificar estructura
        mkdir -p temp-package
        tar -xzf "$PACKAGE_FILE" -C temp-package
        cd temp-package/package
        
        echo "Estructura del package:"
        find . -type f -name "*.js" | head -10
        
        echo " package.json contenido:"
        cat package.json
        
        # Verificar que los archivos principales existen
        if [ -f "src/math.js" ] && [ -f "src/app.js" ]; then
          echo " Archivos principales presentes"
        else
          echo " Faltan archivos principales"
          exit 1
        fi
        
    - name: Subir artefacto (package)
      uses: actions/upload-artifact@v4
      with:
        name: application-package
        path: '*.tgz'
        retention-days: 30
    - name: Verificaci贸n avanzada del package
      run: |
        echo "И Ejecutando verificaci贸n avanzada..."
        npm run verify-package